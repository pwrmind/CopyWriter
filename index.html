<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Текстовый редактор для социальных сетей</title>
    
    <!-- Подключение Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Подключение Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Подключение Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;500;600&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Подключение Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        
        .editor-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
            padding: 10px 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        
        .toolbar-group:last-child {
            margin-right: 0;
        }
        
        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 6px 10px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            background-color: #f0f0f0;
            border-color: #ddd;
        }
        
        .editor-area {
            flex: 1;
            padding: 20px;
            overflow: auto;
            background-color: #fff;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .editor-area:focus {
            box-shadow: inset 0 0 0 2px #007bff;
        }
        
        .status-bar {
            background-color: #343a40;
            color: #fff;
            padding: 8px 15px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        
        .status-item {
            margin-right: 20px;
        }
        
        .status-item:last-child {
            margin-right: 0;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .search-modal {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .font-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .font-option:hover {
            background-color: #f8f9fa;
        }
        
        .highlight {
            background-color: yellow;
        }
        
        .current-highlight {
            background-color: orange;
        }
        
        /* Для обработки Enter и новых строк */
        .editor-area[contenteditable="true"] {
            -webkit-user-modify: read-write-plaintext-only;
        }
    </style>
</head>
<body>
    <div x-data="textEditor()" class="editor-container">
        <!-- Верхняя панель инструментов -->
        <div class="toolbar">
            <div class="d-flex align-items-center">
                <!-- Группа "Буфер обмена" -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" title="Вырезать" @click="cutText">
                        <i class="fas fa-cut"></i>
                    </button>
                    <button class="toolbar-btn" title="Копировать" @click="copyText">
                        <i class="far fa-copy"></i>
                    </button>
                    <button class="toolbar-btn" title="Вставить" @click="pasteText">
                        <i class="far fa-clipboard"></i>
                    </button>
                </div>
                
                <!-- Группа "Отмена/Повтор" -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" title="Отменить" :disabled="!canUndo" @click="undo">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="toolbar-btn" title="Повторить" :disabled="!canRedo" @click="redo">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <!-- Группа "Шрифт" -->
                <div class="toolbar-group">
                    <select class="form-select form-select-sm" style="width: 180px;" x-model="selectedFont" @change="applyFont">
                        <template x-for="font in availableFonts" :key="font">
                            <option :value="font" :selected="selectedFont === font" x-text="font"></option>
                        </template>
                    </select>
                    
                    <select class="form-select form-select-sm ms-2" style="width: 80px;" x-model="selectedFontSize" @change="applyFontSize">
                        <template x-for="size in fontSizes" :key="size">
                            <option :value="size" :selected="selectedFontSize === size" x-text="size"></option>
                        </template>
                    </select>
                </div>
                
                <!-- Группа "Поиск" -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" title="Найти и заменить" @click="showSearchModal = true">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Центральная область редактирования -->
        <div 
            class="editor-area" 
            contenteditable="true" 
            x-ref="editor"
            :style="`font-family: '${selectedFont}', sans-serif; font-size: ${selectedFontSize}px;`"
            @input="handleInput"
            @keydown="handleKeydown"
            @paste="handlePaste"
        ></div>
        
        <!-- Нижняя строка состояния -->
        <div class="status-bar">
            <div class="d-flex">
                <div class="status-item">
                    Символов: <span x-text="stats.charactersWithSpaces"></span> (<span x-text="stats.charactersWithoutSpaces"></span> без пробелов)
                </div>
                <div class="status-item">
                    Слов: <span x-text="stats.words"></span>
                </div>
                <div class="status-item">
                    Предложений: <span x-text="stats.sentences"></span>
                </div>
                <div class="status-item">
                    Абзацев: <span x-text="stats.paragraphs"></span>
                </div>
            </div>
            <div class="status-item">
                Время чтения: ~<span x-text="stats.readingTime"></span> мин.
            </div>
        </div>
        
        <!-- Модальное окно поиска и замены -->
        <template x-if="showSearchModal">
            <div class="modal-overlay" @click.self="showSearchModal = false">
                <div class="search-modal">
                    <h5 class="mb-3">Найти и заменить</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Найти:</label>
                        <input type="text" class="form-control" x-model="searchTerm">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Заменить на:</label>
                        <input type="text" class="form-control" x-model="replaceTerm">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="caseSensitive" x-model="caseSensitive">
                        <label class="form-check-label" for="caseSensitive">
                            С учётом регистра
                        </label>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div>
                            <button class="btn btn-primary btn-sm" @click="findNext">Найти следующее</button>
                            <button class="btn btn-warning btn-sm ms-2" @click="replaceCurrent">Заменить</button>
                            <button class="btn btn-danger btn-sm ms-2" @click="replaceAll">Заменить все</button>
                        </div>
                        <button class="btn btn-secondary btn-sm" @click="closeSearchModal">Закрыть</button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('textEditor', () => ({
                // Состояние приложения
                content: 'Начните вводить текст здесь...',
                selectedFont: 'Roboto',
                selectedFontSize: 16,
                showSearchModal: false,
                searchTerm: '',
                replaceTerm: '',
                caseSensitive: false,
                searchMatches: [],
                currentMatchIndex: -1,
                
                // История действий
                history: [],
                historyIndex: -1,
                
                // Доступные шрифты
                availableFonts: [
                    'Roboto',
                    'Open Sans',
                    'Lato',
                    'Montserrat',
                    'Source Sans Pro'
                ],
                
                // Доступные размеры шрифтов
                fontSizes: [12, 14, 16, 18, 20, 24, 28, 32],
                
                // Статистика
                stats: {
                    charactersWithSpaces: 0,
                    charactersWithoutSpaces: 0,
                    words: 0,
                    sentences: 0,
                    paragraphs: 0,
                    readingTime: 0
                },
                
                // Инициализация
                init() {
                    // Устанавливаем начальный текст
                    this.$refs.editor.textContent = this.content;
                    this.updateStats();
                    this.saveToHistory();
                    
                    // Загрузка сохраненного контента из localStorage
                    const savedContent = localStorage.getItem('editorContent');
                    if (savedContent) {
                        this.content = savedContent;
                        this.$refs.editor.textContent = savedContent;
                        this.updateStats();
                    }
                    
                    // Автосохранение каждые 30 секунд
                    setInterval(() => {
                        this.saveContent();
                    }, 30000);
                },
                
                // Обработка ввода
                handleInput() {
                    this.updateStats();
                    this.saveToHistory();
                },
                
                // Обновление статистики
                updateStats() {
                    const text = this.$refs.editor.textContent || '';
                    this.content = text;
                    
                    // Символы с пробелами и без
                    this.stats.charactersWithSpaces = text.length;
                    this.stats.charactersWithoutSpaces = text.replace(/\s/g, '').length;
                    
                    // Слова
                    const words = text.trim() ? text.trim().split(/\s+/) : [];
                    this.stats.words = words.length;
                    
                    // Предложения
                    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
                    this.stats.sentences = sentences.length;
                    
                    // Абзацы
                    const paragraphs = text.split(/\n+/).filter(p => p.trim().length > 0);
                    this.stats.paragraphs = paragraphs.length;
                    
                    // Время чтения (предполагаем 200 слов в минуту)
                    this.stats.readingTime = Math.max(1, Math.ceil(this.stats.words / 200));
                    
                    // Сохранение контента
                    this.saveContent();
                },
                
                // Сохранение контента в localStorage
                saveContent() {
                    localStorage.setItem('editorContent', this.content);
                },
                
                // Сохранение в историю
                saveToHistory() {
                    const currentText = this.$refs.editor.textContent;
                    
                    // Если текст не изменился, не сохраняем в историю
                    if (this.history[this.historyIndex] === currentText) {
                        return;
                    }
                    
                    // Удаляем все действия после текущего индекса (если мы не в конце истории)
                    if (this.historyIndex < this.history.length - 1) {
                        this.history = this.history.slice(0, this.historyIndex + 1);
                    }
                    
                    // Добавляем текущее состояние
                    this.history.push(currentText);
                    
                    // Ограничиваем глубину истории
                    if (this.history.length > 50) {
                        this.history.shift();
                    } else {
                        this.historyIndex = this.history.length - 1;
                    }
                },
                
                // Отмена действия
                undo() {
                    if (this.historyIndex > 0) {
                        this.historyIndex--;
                        const previousText = this.history[this.historyIndex];
                        this.$refs.editor.textContent = previousText;
                        this.content = previousText;
                        this.updateStats();
                        
                        // Восстанавливаем позицию курсора в конец текста
                        this.setCursorToEnd();
                    }
                },
                
                // Повтор действия
                redo() {
                    if (this.historyIndex < this.history.length - 1) {
                        this.historyIndex++;
                        const nextText = this.history[this.historyIndex];
                        this.$refs.editor.textContent = nextText;
                        this.content = nextText;
                        this.updateStats();
                        
                        // Восстанавливаем позицию курсора в конец текста
                        this.setCursorToEnd();
                    }
                },
                
                // Установка курсора в конец текста
                setCursorToEnd() {
                    const editor = this.$refs.editor;
                    const range = document.createRange();
                    const selection = window.getSelection();
                    
                    range.selectNodeContents(editor);
                    range.collapse(false); // false - в конец
                    
                    selection.removeAllRanges();
                    selection.addRange(range);
                },
                
                // Проверка возможности отмены
                get canUndo() {
                    return this.historyIndex > 0;
                },
                
                // Проверка возможности повтора
                get canRedo() {
                    return this.historyIndex < this.history.length - 1;
                },
                
                // Применение шрифта
                applyFont() {
                    this.$refs.editor.style.fontFamily = `'${this.selectedFont}', sans-serif`;
                },
                
                // Применение размера шрифта
                applyFontSize() {
                    this.$refs.editor.style.fontSize = `${this.selectedFontSize}px`;
                },
                
                // Обработка нажатия клавиш
                handleKeydown(e) {
                    // Сохранение в историю при значимых изменениях
                    if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
                        // Используем setTimeout, чтобы изменение успело произойти
                        setTimeout(() => {
                            this.saveToHistory();
                        }, 0);
                    }
                    
                    // Обработка Enter для создания новой строки
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.insertTextAtCursor('\n');
                    }
                },
                
                // Вставка текста в позицию курсора
                insertTextAtCursor(text) {
                    const editor = this.$refs.editor;
                    const selection = window.getSelection();
                    
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.deleteContents();
                        
                        // Создаем текстовый узел
                        const textNode = document.createTextNode(text);
                        range.insertNode(textNode);
                        
                        // Перемещаем курсор после вставленного текста
                        range.setStartAfter(textNode);
                        range.collapse(true);
                        
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    
                    this.updateStats();
                    this.saveToHistory();
                },
                
                // Обработка вставки текста
                handlePaste(e) {
                    e.preventDefault();
                    
                    // Получаем текст из буфера обмена
                    const text = e.clipboardData.getData('text/plain');
                    
                    // Вставляем текст в текущую позицию курсора
                    this.insertTextAtCursor(text);
                },
                
                // Вырезание текста
                cutText() {
                    const editor = this.$refs.editor;
                    const selection = window.getSelection();
                    
                    if (selection.toString()) {
                        // Копируем выделенный текст в буфер обмена
                        navigator.clipboard.writeText(selection.toString())
                            .then(() => {
                                // Удаляем выделенный текст
                                const range = selection.getRangeAt(0);
                                range.deleteContents();
                                
                                this.updateStats();
                                this.saveToHistory();
                            })
                            .catch(err => {
                                console.error('Ошибка при вырезании текста:', err);
                            });
                    }
                },
                
                // Копирование текста
                copyText() {
                    const editor = this.$refs.editor;
                    const selection = window.getSelection();
                    
                    if (selection.toString()) {
                        navigator.clipboard.writeText(selection.toString())
                            .catch(err => {
                                console.error('Ошибка при копировании текста:', err);
                            });
                    }
                },
                
                // Вставка текста
                pasteText() {
                    // Фокусируемся на редакторе
                    this.$refs.editor.focus();
                    
                    // Используем Clipboard API для вставки
                    navigator.clipboard.readText()
                        .then(text => {
                            this.insertTextAtCursor(text);
                        })
                        .catch(err => {
                            console.error('Ошибка при вставке текста:', err);
                            // Fallback для старых браузеров
                            document.execCommand('paste');
                        });
                },
                
                // Поиск следующего совпадения
                findNext() {
                    if (!this.searchTerm) return;
                    
                    const editor = this.$refs.editor;
                    const text = editor.textContent || '';
                    const searchTerm = this.caseSensitive ? this.searchTerm : this.searchTerm.toLowerCase();
                    const content = this.caseSensitive ? text : text.toLowerCase();
                    
                    // Находим все совпадения
                    this.searchMatches = [];
                    let match;
                    const regex = new RegExp(this.escapeRegex(this.searchTerm), this.caseSensitive ? 'g' : 'gi');
                    
                    while ((match = regex.exec(text)) !== null) {
                        this.searchMatches.push({
                            start: match.index,
                            end: match.index + match[0].length
                        });
                    }
                    
                    // Переходим к следующему совпадению
                    if (this.searchMatches.length > 0) {
                        this.currentMatchIndex = (this.currentMatchIndex + 1) % this.searchMatches.length;
                        this.highlightCurrentMatch();
                    }
                },
                
                // Замена текущего совпадения
                replaceCurrent() {
                    if (this.currentMatchIndex >= 0 && this.searchMatches.length > 0) {
                        const match = this.searchMatches[this.currentMatchIndex];
                        const editor = this.$refs.editor;
                        const text = editor.textContent || '';
                        
                        // Заменяем текст
                        const newText = text.substring(0, match.start) + this.replaceTerm + text.substring(match.end);
                        editor.textContent = newText;
                        
                        // Обновляем статистику и историю
                        this.updateStats();
                        this.saveToHistory();
                        
                        // Убираем текущее совпадение из списка
                        this.searchMatches.splice(this.currentMatchIndex, 1);
                        
                        // Переходим к следующему совпадению
                        if (this.searchMatches.length > 0) {
                            this.currentMatchIndex = this.currentMatchIndex % this.searchMatches.length;
                            this.highlightCurrentMatch();
                        } else {
                            this.currentMatchIndex = -1;
                        }
                    }
                },
                
                // Замена всех совпадений
                replaceAll() {
                    if (!this.searchTerm) return;
                    
                    const editor = this.$refs.editor;
                    const text = editor.textContent || '';
                    const regex = new RegExp(this.escapeRegex(this.searchTerm), this.caseSensitive ? 'g' : 'gi');
                    const newText = text.replace(regex, this.replaceTerm);
                    
                    editor.textContent = newText;
                    
                    // Обновляем статистику и историю
                    this.updateStats();
                    this.saveToHistory();
                    
                    // Сбрасываем поиск
                    this.searchMatches = [];
                    this.currentMatchIndex = -1;
                },
                
                // Подсветка текущего совпадения
                highlightCurrentMatch() {
                    // Сначала убираем все подсветки
                    this.clearHighlights();
                    
                    if (this.currentMatchIndex >= 0 && this.searchMatches.length > 0) {
                        const match = this.searchMatches[this.currentMatchIndex];
                        const editor = this.$refs.editor;
                        
                        // Создаем диапазон для выделения
                        const range = document.createRange();
                        
                        // Находим текстовый узел и позицию
                        const textNode = editor.firstChild; // У нас только текстовый узел
                        if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                            const startOffset = Math.min(match.start, textNode.length);
                            const endOffset = Math.min(match.end, textNode.length);
                            
                            range.setStart(textNode, startOffset);
                            range.setEnd(textNode, endOffset);
                            
                            // Выделяем текст
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                            
                            // Прокручиваем к выделенному тексту
                            editor.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                        }
                    }
                },
                
                // Очистка подсветок
                clearHighlights() {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                },
                
                // Закрытие модального окна поиска
                closeSearchModal() {
                    this.showSearchModal = false;
                    this.clearHighlights();
                    this.searchMatches = [];
                    this.currentMatchIndex = -1;
                },
                
                // Экранирование специальных символов для регулярных выражений
                escapeRegex(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }
            }));
        });
    </script>
</body>
</html>
